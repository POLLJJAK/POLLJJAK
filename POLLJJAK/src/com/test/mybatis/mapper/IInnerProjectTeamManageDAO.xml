<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.test.mybatis.IInnerProjectTeamManageDAO">
	
	<select id="pj_title_info" resultType="com.test.dto.InnerProjectTeamManageDTO">
		SELECT
		P3.P_NAME AS P_NAME
		, TO_CHAR(P3.PJ_START_DATE,'YYYY-MM-DD') AS PJ_START_DATE
		, TO_CHAR(P3.PJ_END_DATE, 'YYYY-MM-DD') AS PJ_END_DATE,
		ROUND(NVL((
			SELECT COUNT(*)
			FROM PH_SUBWORK_COMPLETE 
			WHERE PH_SUBWORK_CODE IN (
				SELECT PH_SUBWORK_CODE
				FROM PH_SUBWORK
				WHERE U_P_APPLY_CODE IN (		    
					SELECT U_P_APPLY_CODE
					FROM P_POSITION A1, U_P_APPLY A2
					WHERE P_CODE = (		    
						SELECT I3.P_CODE
						FROM U_P_APPLY I1, P_POSITION I2, P_TEAM_CONFIRM I3, P_END I4
						WHERE I1.U_P_APPLY_CODE =  #{u_p_apply_code} 
						  AND I1.P_POSITION_CODE = I2.P_POSITION_CODE
						  AND I2.P_CODE = I3.P_CODE
						  AND NOT I3.P_TEAM_CONFIRM_CODE = I4.P_TEAM_CONFIRM_CODE
					)
					AND A1.P_POSITION_CODE = A2.P_POSITION_CODE
					AND U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
				)
			)
		)/DECODE(
		(
			SELECT COUNT(*)
			FROM PH_SUBWORK
			WHERE U_P_APPLY_CODE IN (		    
				SELECT U_P_APPLY_CODE
				FROM P_POSITION A1, U_P_APPLY A2
				WHERE P_CODE = (		    
					SELECT I3.P_CODE
					FROM U_P_APPLY I1, P_POSITION I2, P_TEAM_CONFIRM I3, P_END I4
					WHERE I1.U_P_APPLY_CODE =  #{u_p_apply_code} 
					  AND I1.P_POSITION_CODE = I2.P_POSITION_CODE
					  AND I2.P_CODE = I3.P_CODE
					  AND NOT I3.P_TEAM_CONFIRM_CODE = I4.P_TEAM_CONFIRM_CODE
				)
				AND A1.P_POSITION_CODE = A2.P_POSITION_CODE
				AND U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
			)
		)
		,0, NULL, 
		(
			SELECT COUNT(*)
			FROM PH_SUBWORK
			WHERE U_P_APPLY_CODE IN (		    
				SELECT U_P_APPLY_CODE
				FROM P_POSITION A1, U_P_APPLY A2
				WHERE P_CODE = (		    
					SELECT I3.P_CODE
					FROM U_P_APPLY I1, P_POSITION I2, P_TEAM_CONFIRM I3, P_END I4
					WHERE I1.U_P_APPLY_CODE =  #{u_p_apply_code} 
					  AND I1.P_POSITION_CODE = I2.P_POSITION_CODE
					  AND I2.P_CODE = I3.P_CODE
					  AND NOT I3.P_TEAM_CONFIRM_CODE = I4.P_TEAM_CONFIRM_CODE
				)
				AND A1.P_POSITION_CODE = A2.P_POSITION_CODE
				AND U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
			)
		)
		), 0)*100, 0) AS ALL_PERCENT
	    , P3.P_CODE AS PJ_CODE
	    ,
	    (
	    	CASE WHEN P3.P_CODE IN (
			    SELECT PT.P_CODE
				FROM P_TEAM_CONFIRM PT, P_END PE
				WHERE PT.P_TEAM_CONFIRM_CODE = PE.P_TEAM_CONFIRM_CODE
			) THEN '종료'
			ELSE '진행'
			END
	    ) AS PJ_END_CHECK
	    FROM U_P_APPLY P1, P_POSITION P2, P P3
        WHERE P1.U_P_APPLY_CODE = #{u_p_apply_code}
		  AND P1.P_POSITION_CODE = P2.P_POSITION_CODE
		  AND P2.P_CODE = P3.P_CODE
	</select>
	
	<select id="pj_team_info" resultType="com.test.dto.InnerProjectTeamManageDTO">
	SELECT 
		CASE WHEN (
			SELECT U_P_APPLY_CODE
			FROM P_LEADER
			WHERE P_LEADER_DATE = (
				SELECT MAX(P_LEADER_DATE)
				FROM P_LEADER
				WHERE U_P_APPLY_CODE IN (
					SELECT P3.U_P_APPLY_CODE
					FROM P P1, P_POSITION P2, U_P_APPLY P3
					WHERE P1.P_CODE = (
						SELECT T3.P_CODE
						FROM U_P_APPLY T1, P_POSITION T2, P T3
						WHERE T1.U_P_APPLY_CODE =  #{u_p_apply_code}
						  AND T1.P_POSITION_CODE = T2.P_POSITION_CODE
						  AND T2.P_CODE = T3.P_CODE
					)  
					  AND P1.P_CODE = P2.P_CODE
					  AND P2.P_POSITION_CODE = P3.P_POSITION_CODE
					  AND P3.U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
				)	
			)
			AND U_P_APPLY_CODE IN (
					SELECT P3.U_P_APPLY_CODE
					FROM P P1, P_POSITION P2, U_P_APPLY P3
					WHERE P1.P_CODE = (
						SELECT T3.P_CODE
						FROM U_P_APPLY T1, P_POSITION T2, P T3
						WHERE T1.U_P_APPLY_CODE =  #{u_p_apply_code}
						  AND T1.P_POSITION_CODE = T2.P_POSITION_CODE
						  AND T2.P_CODE = T3.P_CODE
					)  
					  AND P1.P_CODE = P2.P_CODE
					  AND P2.P_POSITION_CODE = P3.P_POSITION_CODE
					  AND P3.U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
			)
		)= B2.U_P_APPLY_CODE THEN '팀장' ELSE '팀원'
		END AS TEAM_ROLE
		
		, B2.U_P_APPLY_CODE, B2.USER_CODE, B1.POSITION_PART_CODE
		, B3.POSITION_PART, B4.U_NAME, NVL(B5.CONTRIBUTE, 0) AS CONTRIBUTE
		, B6.LAST_LOGIN_DATE
		FROM P_POSITION B1, U_P_APPLY B2, POSITION_PART B3, U B4,
		(
			SELECT U_P_APPLY_CODE, ROUND(ALL_COUNT /
			(
				SELECT COUNT(*)
				FROM PH_SUBWORK
				WHERE U_P_APPLY_CODE IN (
					SELECT P3.U_P_APPLY_CODE
					FROM P P1, P_POSITION P2, U_P_APPLY P3
					WHERE P1.P_CODE = (
						SELECT T3.P_CODE
						FROM U_P_APPLY T1, P_POSITION T2, P T3
						WHERE T1.U_P_APPLY_CODE =  #{u_p_apply_code}
						  AND T1.P_POSITION_CODE = T2.P_POSITION_CODE
						  AND T2.P_CODE = T3.P_CODE
					)  
					  AND P1.P_CODE = P2.P_CODE
					  AND P2.P_POSITION_CODE = P3.P_POSITION_CODE
					  AND P3.U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
				)
			)*100, 0) AS CONTRIBUTE
			FROM
			(
				SELECT U_P_APPLY_CODE, COUNT(*) AS ALL_COUNT
				FROM PH_SUBWORK
				GROUP BY U_P_APPLY_CODE
				HAVING U_P_APPLY_CODE IN
				(
					SELECT P3.U_P_APPLY_CODE
					FROM P P1, P_POSITION P2, U_P_APPLY P3
					WHERE P1.P_CODE = (
						SELECT T3.P_CODE
						FROM U_P_APPLY T1, P_POSITION T2, P T3
						WHERE T1.U_P_APPLY_CODE =  #{u_p_apply_code}
						  AND T1.P_POSITION_CODE = T2.P_POSITION_CODE
						  AND T2.P_CODE = T3.P_CODE
					)  
					  AND P1.P_CODE = P2.P_CODE
					  AND P2.P_POSITION_CODE = P3.P_POSITION_CODE
					  AND P3.U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
				)
			)
		) B5,
		(
			SELECT USER_CODE, TO_CHAR(MAX(USER_LOGIN_LOG_DATE), 'YYYY-MM-DD') AS LAST_LOGIN_DATE
			FROM USER_LOGIN_LOG
			GROUP BY USER_CODE 
			HAVING USER_CODE IN
			(
				SELECT P3.USER_CODE
				FROM P P1, P_POSITION P2, U_P_APPLY P3
				WHERE P1.P_CODE = (
					SELECT T3.P_CODE
					FROM U_P_APPLY T1, P_POSITION T2, P T3
					WHERE T1.U_P_APPLY_CODE =  #{u_p_apply_code}
					  AND T1.P_POSITION_CODE = T2.P_POSITION_CODE
					  AND T2.P_CODE = T3.P_CODE
				)  
				  AND P1.P_CODE = P2.P_CODE
				  AND P2.P_POSITION_CODE = P3.P_POSITION_CODE
				  AND P3.U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
			)
		) B6
		WHERE P_CODE = (
			SELECT A3.P_CODE
			FROM U_P_APPLY A1, P_POSITION A2, P A3
			WHERE U_P_APPLY_CODE =  #{u_p_apply_code}
			  AND A1.P_POSITION_CODE = A2.P_POSITION_CODE
			  AND A2.P_CODE = A3.P_CODE
		)
		AND B1.P_POSITION_CODE = B2.P_POSITION_CODE
		AND B1.POSITION_PART_CODE = B3.POSITION_PART_CODE
		AND B2.USER_CODE = B4.USER_CODE
		AND B2.U_P_APPLY_CODE = B5.U_P_APPLY_CODE(+)
		AND B2.USER_CODE = B6.USER_CODE
	</select>


	<select id="pj_team_count" resultType="java.lang.Integer">
		SELECT COUNT(*) AS TEAM_MEMBER_COUNT
		FROM P B1, P_POSITION B2, U_P_APPLY B3
		WHERE B1.P_CODE = (
			SELECT A3.P_CODE
			FROM U_P_APPLY A1, P_POSITION A2, P A3
			WHERE A1.U_P_APPLY_CODE = #{u_p_apply_code}
			  AND A1.P_POSITION_CODE = A2.P_POSITION_CODE
			  AND A2.P_CODE = A3.P_CODE
		)
		AND B1.P_CODE = B2.P_CODE
		AND B2.P_POSITION_CODE = B3.P_POSITION_CODE
		AND B3.U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
	</select>
	

	<select id="pj_team_now_count" resultType="java.lang.Integer">
		SELECT SUM(P_POSITION_COUNT) AS TEAM_MEMBER_COUNT
		FROM P_POSITION
		WHERE P_CODE = (SELECT A3.P_CODE
		FROM U_P_APPLY A1, P_POSITION A2, P A3
		WHERE U_P_APPLY_CODE = #{u_p_apply_code}
		  AND A1.P_POSITION_CODE = A2.P_POSITION_CODE
		  AND A2.P_CODE = A3.P_CODE)
	</select>
	
	<select id="upa_p_code" resultType="com.test.dto.InnerProjectTeamManageDTO">
		 SELECT A2.P_CODE AS P_CODE
		 FROM U_P_APPLY A1, P_POSITION A2, P_TEAM_CONFIRM A3, P_END A4
		WHERE A1.U_P_APPLY_CODE = #{u_p_apply_code}
		  AND A1.P_POSITION_CODE = A2.P_POSITION_CODE
		  AND A2.P_CODE = A3.P_CODE 
		  AND A3.P_TEAM_CONFIRM_CODE = A4.P_TEAM_CONFIRM_CODE
	</select>
	
	
	
	<select id="pj_team_leader" resultType="com.test.dto.InnerProjectTeamManageDTO">
		SELECT U_P_APPLY_CODE
		FROM P_LEADER 
		WHERE P_LEADER_CODE = (
			SELECT MAX(B4.P_LEADER_CODE)
			FROM P B1, P_POSITION B2, U_P_APPLY B3, P_LEADER B4
			WHERE B1.P_CODE = ( 
				SELECT A3.P_CODE
				FROM U_P_APPLY A1, P_POSITION A2, P A3, P_TEAM_CONFIRM A4
				WHERE A1.U_P_APPLY_CODE = #{u_p_apply_code}
				  AND A1.P_POSITION_CODE = A2.P_POSITION_CODE
				  AND A2.P_CODE = A3.P_CODE
				  AND A3.P_CODE = A4.P_CODE
			)
			AND B1.P_CODE = B2.P_CODE
			AND B2.P_POSITION_CODE = B3.P_POSITION_CODE
			AND B3.U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
			AND B3.U_P_APPLY_CODE = B4.U_P_APPLY_CODE 
			AND B3.U_P_APPLY_CODE IN ( SELECT U_P_APPLY_CODE FROM P_LEADER )
			)
	</select>
	
	
	<insert id="pj_team_leader_move">
		INSERT INTO P_LEADER(P_LEADER_CODE, U_P_APPLY_CODE, P_LEADER_DATE, P_LEADER_REASON)
		VALUES('PL'||LPAD(P_LEADER_CODE_SEQ.NEXTVAL, 8, '0'), #{team_member}, SYSDATE, #{p_leader_reason})
	</insert>
	
	<select id="pj_team_leader_modal_list" resultType="com.test.dto.InnerProjectTeamManageDTO">
		SELECT P3.U_P_APPLY_CODE, P4.U_NAME
		FROM P P1, P_POSITION P2, U_P_APPLY P3, U P4
		WHERE P1.P_CODE = (
			SELECT T3.P_CODE
			FROM U_P_APPLY T1, P_POSITION T2, P T3
			WHERE T1.U_P_APPLY_CODE =  #{u_p_apply_code}
			  AND T1.P_POSITION_CODE = T2.P_POSITION_CODE
			  AND T2.P_CODE = T3.P_CODE
		)  
		  AND P1.P_CODE = P2.P_CODE
		  AND P2.P_POSITION_CODE = P3.P_POSITION_CODE
		  AND P3.U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
		  AND P3.U_P_APPLY_CODE != #{u_p_apply_code}
		  AND P3.USER_CODE = P4.USER_CODE
	</select>
	
	
	
	
	<insert id="p_stop_teamMember">
		INSERT INTO P_STOP(P_STOP_CODE, U_P_APPLY_CODE, P_STOP_DATE)
		VALUES ('PSTP'||P_STOP_CODE_SEQ.NEXTVAL, #{u_p_apply_code}, SYSDATE)
	</insert>
	


	<resultMap type="HashMap" id="member_stop_check_map">
		<id column="u_name" property="u_name" />
		<id column="member_stop_check" property="member_stop_check" />
		<id column="u_p_apply_code" property="u_p_apply_code" />
	</resultMap>

	<select id="p_stop_teamMember_check" resultMap="member_stop_check_map">
		SELECT B5.U_NAME, (
			SELECT COUNT(*)
			FROM P_STOP
			WHERE U_P_APPLY_CODE = B3.U_P_APPLY_CODE
		) AS MEMBER_STOP_CHECK
		, B3.U_P_APPLY_CODE
		FROM P B1, P_POSITION B2, U_P_APPLY B3, U B5
		WHERE B1.P_CODE = (
			SELECT A3.P_CODE
			FROM U_P_APPLY A1, P_POSITION A2, P A3
			WHERE A1.U_P_APPLY_CODE = #{u_p_apply_code}
			  AND A1.P_POSITION_CODE = A2.P_POSITION_CODE
			  AND A2.P_CODE = A3.P_CODE
		)
		AND B1.P_CODE = B2.P_CODE 
		AND B2.P_POSITION_CODE = B3.P_POSITION_CODE
		AND  B3.U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
		AND B3.USER_CODE = B5.USER_CODE
	</select>

	
	
	<select id="p_stop_upa_check" resultType="com.test.dto.InnerProjectTeamManageDTO">
		SELECT U_P_APPLY_CODE
		FROM P_STOP
		WHERE U_P_APPLY_CODE = #{u_p_apply_code}
	</select>
	
	
	
	<select id="p_stop_teamMember_count" resultType="java.lang.Integer">
		SELECT COUNT(*) AS TEAM_P_STOP_COUNT
		FROM P_STOP 
		WHERE U_P_APPLY_CODE IN (
			SELECT B3.U_P_APPLY_CODE
			FROM P B1, P_POSITION B2, U_P_APPLY B3, P_REJECT B4
			WHERE B1.P_CODE = (
				SELECT A3.P_CODE
				FROM U_P_APPLY A1, P_POSITION A2, P A3
				WHERE A1.U_P_APPLY_CODE = #{u_p_apply_code}
				  AND A1.P_POSITION_CODE = A2.P_POSITION_CODE
				  AND A2.P_CODE = A3.P_CODE
			)
			AND B1.P_CODE = B2.P_CODE 
			AND B2.P_POSITION_CODE = B3.P_POSITION_CODE
			AND NOT B3.U_P_APPLY_CODE = B4.U_P_APPLY_CODE
		)
	</select>
	
	
	<select id="p_team_confirm_code" resultType="com.test.dto.InnerProjectTeamManageDTO">
		SELECT B2.P_TEAM_CONFIRM_CODE AS P_TEAM_CONFIRM_CODE
		FROM P B1, P_TEAM_CONFIRM B2
		WHERE B1.P_CODE = (
			SELECT A3.P_CODE
			FROM U_P_APPLY A1, P_POSITION A2, P A3
			WHERE A1.U_P_APPLY_CODE = #{u_p_apply_code}
			  AND A1.P_POSITION_CODE = A2.P_POSITION_CODE
			  AND A2.P_CODE = A3.P_CODE
		)
		AND B1.P_CODE = B2.P_CODE
		AND B2.P_TEAM_CONFIRM_CODE NOT IN ( SELECT P_TEAM_CONFIRM_CODE FROM P_END )
	</select>



	<insert id="p_stop_project_insert"  parameterType="com.test.dto.InnerProjectTeamManageDTO">
		INSERT INTO P_END(P_END_CODE, P_TEAM_CONFIRM_CODE, P_END_CONDITION_CODE, P_END_DATE, P_STOP_REASON)
		VALUES('PEC'||LPAD(P_END_CODE_SEQ.NEXTVAL, 7, '0'), #{p_team_confirm_code}, 'PEC0000003', SYSDATE, #{p_stop_reason})
	</insert>
	
	
	
	<insert id="teamEvaluation">
		INSERT INTO P_RATING(P_RATING_CODE, RECEIVE_U_P_APPLY_CODE, SEND_U_P_APPLY_CODE, P_RATING, P_RATING_DATE)
		SELECT ('PR'||LPAD(P_RATING_CODE_SEQ.NEXTVAL, 8, '0')), A.*
		FROM (
		<foreach collection="list" item="item"  index="index" separator=" UNION ALL ">
			SELECT #{u_p_apply_code} AS U_P_APPLY_CODE
			, #{} AS TEAM_MEMBER
			, #{} AS RATING_VAL
			, SYSDATE
			FROM DUAL 
		</foreach>
		) A
	</insert>
	
	
	
	
	
	
	
	
</mapper>