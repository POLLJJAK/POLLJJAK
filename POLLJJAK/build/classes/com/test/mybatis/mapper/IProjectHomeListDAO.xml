<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.test.mybatis.IProjectHomeListDAO">
	
	<select id="pj_run_list" resultType="com.test.dto.ProjectHomeListDTO">
		 SELECT T1.P_NAME, T1.USER_CODE,
		 TO_CHAR(T1.PJ_START_DATE, 'YYYY-MM-DD') AS PJ_START_DATE,
		 TO_CHAR(T1.PJ_END_DATE, 'YYYY-MM-DD') AS PJ_END_DATE,
		 T1.P_CODE,
		 T3.U_P_APPLY_CODE,
		 ROUND(NVL((
				SELECT COUNT(*)
				FROM PH_SUBWORK_COMPLETE 
				WHERE PH_SUBWORK_CODE IN (
					SELECT PH_SUBWORK_CODE
					FROM PH_SUBWORK
					WHERE U_P_APPLY_CODE IN (		    
						SELECT U_P_APPLY_CODE
						FROM P_POSITION A1, U_P_APPLY A2
						WHERE P_CODE = (		    
							SELECT I3.P_CODE
							FROM U_P_APPLY I1, P_POSITION I2, P I3, P_TEAM_CONFIRM I4
							WHERE I1.USER_CODE = #{user_code}
							  AND I1.P_POSITION_CODE = I2.P_POSITION_CODE
							  AND I2.P_CODE = I3.P_CODE
							  AND I3.P_CODE = I4.P_CODE 
							  AND I4.P_TEAM_CONFIRM_CODE NOT IN (SELECT P_TEAM_CONFIRM_CODE FROM P_END)
						)
						AND A1.P_POSITION_CODE = A2.P_POSITION_CODE
						AND U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
					)
				)
			)/DECODE(
			(
				SELECT COUNT(*)
				FROM PH_SUBWORK
				WHERE U_P_APPLY_CODE IN (		    
					SELECT U_P_APPLY_CODE
					FROM P_POSITION A1, U_P_APPLY A2
					WHERE P_CODE = (		    
						SELECT I3.P_CODE
						FROM U_P_APPLY I1, P_POSITION I2, P I3, P_TEAM_CONFIRM I4
						WHERE I1.USER_CODE = #{user_code}
						  AND I1.P_POSITION_CODE = I2.P_POSITION_CODE
						  AND I2.P_CODE = I3.P_CODE
						  AND I3.P_CODE = I4.P_CODE 
						  AND I4.P_TEAM_CONFIRM_CODE NOT IN (SELECT P_TEAM_CONFIRM_CODE FROM P_END)
					)
					AND A1.P_POSITION_CODE = A2.P_POSITION_CODE
					AND U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
				)
			)
			,0, NULL, 
			(
				SELECT COUNT(*)
				FROM PH_SUBWORK
				WHERE U_P_APPLY_CODE IN (		    
					SELECT U_P_APPLY_CODE
					FROM P_POSITION A1, U_P_APPLY A2
					WHERE P_CODE = (		    
						SELECT I3.P_CODE
						FROM U_P_APPLY I1, P_POSITION I2, P I3, P_TEAM_CONFIRM I4
						WHERE I1.USER_CODE = #{user_code}
						  AND I1.P_POSITION_CODE = I2.P_POSITION_CODE
						  AND I2.P_CODE = I3.P_CODE
						  AND I3.P_CODE = I4.P_CODE 
						  AND I4.P_TEAM_CONFIRM_CODE NOT IN (SELECT P_TEAM_CONFIRM_CODE FROM P_END)
					)
					AND A1.P_POSITION_CODE = A2.P_POSITION_CODE
					AND U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
				)
			)
			), 0)*100, 0) AS ALL_PERCENT
		 FROM P T1, P_POSITION T2, U_P_APPLY T3, P_TEAM_CONFIRM T4
		 WHERE T1.P_CODE = T2.P_CODE
		   AND T2.P_POSITION_CODE = T3.P_POSITION_CODE 
		   AND T3.USER_CODE =#{user_code}
		   AND T4.P_TEAM_CONFIRM_CODE NOT IN (
		  	SELECT P_TEAM_CONFIRM_CODE
		  	FROM P_END)
	</select>
	
	
	
	
	<select id="pj_complete_list" resultType="com.test.dto.ProjectHomeListDTO">
		 SELECT T1.P_NAME,
		 		T1.USER_CODE,
			   TO_CHAR(T1.PJ_START_DATE, 'YYYY-MM-DD') AS PJ_START_DATE,
		       TO_CHAR(T1.PJ_END_DATE, 'YYYY-MM-DD') AS PJ_END_DATE,
		       T1.P_CODE,
		       T3.U_P_APPLY_CODE,
		       T5.P_END_CONDITION_CODE
		 FROM P T1, P_POSITION T2, U_P_APPLY T3, P_TEAM_CONFIRM T4, P_END T5
		 WHERE T1.P_CODE = T2.P_CODE
		   AND T2.P_POSITION_CODE = T3.P_POSITION_CODE 
		   AND T3.USER_CODE =#{user_code}
		   AND T4.P_TEAM_CONFIRM_CODE = T5.P_TEAM_CONFIRM_CODE
	</select>
	

	
	
</mapper>