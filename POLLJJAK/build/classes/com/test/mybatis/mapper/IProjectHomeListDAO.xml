<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.test.mybatis.IProjectHomeListDAO">
	
	<select id="pj_run_list" resultType="com.test.mybatis.ProjectHomeListDTO">
		  SELECT T1.P_NAME, T1.USER_CODE,
		   TO_CHAR(T1.PJ_START_DATE, 'YYYY-MM-DD') AS PJ_START_DATE,
	       TO_CHAR(T1.PJ_END_DATE, 'YYYY-MM-DD') AS PJ_END_DATE,
	       T1.P_CODE,
	       T5.U_P_APPLY_CODE,
		   ROUND(NVL(
	   	   (
	       SELECT COUNT(*)
	 	   FROM U_P_APPLY I1, PH_MAINWORK I2, PH_SUBWORK I3
		   WHERE I1.USER_CODE = #{user_code}
		     AND I1.U_P_APPLY_CODE = I2.U_P_APPLY_CODE
		     AND I2.PH_MAINWORK_CODE = I3.PH_MAINWORK_CODE
	   )
	   /
	   DECODE(
	   (
		   SELECT COUNT(*)
		   FROM U_P_APPLY I1, PH_MAINWORK I2, PH_SUBWORK I3, PH_SUBWORK_COMPLETE I4
		   WHERE I1.USER_CODE =#{user_code}
		     AND I1.U_P_APPLY_CODE = I2.U_P_APPLY_CODE
		     AND I2.PH_MAINWORK_CODE = I3.PH_MAINWORK_CODE
		     AND I3.PH_SUBWORK_CODE = I4.PH_SUBWORK_CODE
	   )
	   ,0
	   , NULL
	   , (
		   SELECT COUNT(*)
		   FROM U_P_APPLY I1, PH_MAINWORK I2, PH_SUBWORK I3, PH_SUBWORK_COMPLETE I4
		   WHERE I1.USER_CODE =#{user_code}
		     AND I1.U_P_APPLY_CODE = I2.U_P_APPLY_CODE
		     AND I2.PH_MAINWORK_CODE = I3.PH_MAINWORK_CODE
		     AND I3.PH_SUBWORK_CODE = I4.PH_SUBWORK_CODE
	   )), 0)*100, 0)
	   AS ALL_PERCENT
		FROM P T1, P_TEAM_CONFIRM T2, P_END T3, P_POSITION T4, U_P_APPLY T5
		WHERE T1.P_CODE = T2.P_CODE
		  AND T1.P_CODE = T4.P_CODE
		  AND T4.P_POSITION_CODE = T5.P_POSITION_CODE
		  AND NOT (T2.P_TEAM_CONFIRM_CODE = T3.P_TEAM_CONFIRM_CODE)
		  AND T5.USER_CODE = #{user_code}
	</select>
	
	
	
	
	<select id="pj_complete_list" resultType="com.test.mybatis.ProjectHomeListDTO">
		  SELECT T1.P_NAME, T1.USER_CODE,
		   TO_CHAR(T1.PJ_START_DATE, 'YYYY-MM-DD') AS PJ_START_DATE,
	       TO_CHAR(T1.PJ_END_DATE, 'YYYY-MM-DD') AS PJ_END_DATE,
	       T1.P_CODE,
	       T5.U_P_APPLY_CODE,
		   ROUND(NVL(
	   	   (
	       SELECT COUNT(*)
	 	   FROM U_P_APPLY I1, PH_MAINWORK I2, PH_SUBWORK I3
		   WHERE I1.USER_CODE = #{user_code}
		     AND I1.U_P_APPLY_CODE = I2.U_P_APPLY_CODE
		     AND I2.PH_MAINWORK_CODE = I3.PH_MAINWORK_CODE
	   )
	   /
	   DECODE(
	   (
		   SELECT COUNT(*)
		   FROM U_P_APPLY I1, PH_MAINWORK I2, PH_SUBWORK I3, PH_SUBWORK_COMPLETE I4
		   WHERE I1.USER_CODE =#{user_code}
		     AND I1.U_P_APPLY_CODE = I2.U_P_APPLY_CODE
		     AND I2.PH_MAINWORK_CODE = I3.PH_MAINWORK_CODE
		     AND I3.PH_SUBWORK_CODE = I4.PH_SUBWORK_CODE
	   )
	   ,0
	   , NULL
	   , (
		   SELECT COUNT(*)
		   FROM U_P_APPLY I1, PH_MAINWORK I2, PH_SUBWORK I3, PH_SUBWORK_COMPLETE I4
		   WHERE I1.USER_CODE =#{user_code}
		     AND I1.U_P_APPLY_CODE = I2.U_P_APPLY_CODE
		     AND I2.PH_MAINWORK_CODE = I3.PH_MAINWORK_CODE
		     AND I3.PH_SUBWORK_CODE = I4.PH_SUBWORK_CODE
	   )), 0)*100, 0)
	   AS ALL_PERCENT
		FROM P T1, P_TEAM_CONFIRM T2, P_END T3, P_POSITION T4, U_P_APPLY T5
		WHERE T1.P_CODE = T2.P_CODE
		  AND T1.P_CODE = T4.P_CODE
		  AND T4.P_POSITION_CODE = T5.P_POSITION_CODE
		  AND (T2.P_TEAM_CONFIRM_CODE = T3.P_TEAM_CONFIRM_CODE)
		  AND T5.USER_CODE = #{user_code}
	</select>
	

	
	
</mapper>