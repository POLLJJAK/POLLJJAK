<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.test.mybatis.IInnerProjectMainWorkDAO">
	
	<select id="pj_mainwork_list" resultType="com.test.dto.InnerProjectMainWorkDTO">
		SELECT PH_MAINWORK_TITLE, PJ_START_DATE, PJ_END_DATE, 
		(
			ROUND(NVL(
					(
					SELECT COUNT(*)
					FROM PH_SUBWORK_COMPLETE 
					WHERE PH_SUBWORK_CODE IN (
						SELECT PH_SUBWORK_CODE
						FROM PH_SUBWORK 
						WHERE PH_MAINWORK_CODE =C1.PH_MAINWORK_CODE)
					)
			/ DECODE(
					(SELECT COUNT(*)
					FROM PH_SUBWORK 
					WHERE PH_MAINWORK_CODE =C1.PH_MAINWORK_CODE)
			, 0, NULL ,(
					(SELECT COUNT(*)
					FROM PH_SUBWORK 
					WHERE PH_MAINWORK_CODE =C1.PH_MAINWORK_CODE)
			)), 0)*100, 0)
		) AS MAINWORK_PERCENT
		, PH_MAINWORK_CODE
		FROM 
		(
			SELECT PH_MAINWORK_TITLE
			, TO_CHAR(PH_MAINWORK_START_DATE, 'YYYY-MM-DD') AS PJ_START_DATE
			, TO_CHAR(PH_MAINWORK_END_DATE, 'YYYY-MM-DD') AS PJ_END_DATE
			, PH_MAINWORK_CODE
			FROM PH_MAINWORK
			WHERE U_P_APPLY_CODE IN (
				SELECT P3.U_P_APPLY_CODE
				FROM P P1, P_POSITION P2, U_P_APPLY P3
				WHERE P1.P_CODE = (
					SELECT T3.P_CODE
					FROM U_P_APPLY T1, P_POSITION T2, P T3
					WHERE T1.U_P_APPLY_CODE = #{u_p_apply_code}
					  AND T1.P_POSITION_CODE = T2.P_POSITION_CODE
					  AND T2.P_CODE = T3.P_CODE
				)  
				 AND P1.P_CODE = P2.P_CODE
				 AND P2.P_POSITION_CODE = P3.P_POSITION_CODE
				 AND P3.U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
			)
		) C1
		ORDER BY 2
	</select>
	


	<resultMap type="HashMap" id="member_list_map">
		<id column="ph_mainwork_title" property="ph_mainwork_title" />
		<id column="u_name" property="u_name" />
	</resultMap>

	<select id="member_list" resultMap="member_list_map">
		SELECT
		PH_MAINWORK_TITLE, C4.U_NAME AS U_NAME
		FROM 
		(
			SELECT PH_MAINWORK_TITLE
			, TO_CHAR(PH_MAINWORK_START_DATE, 'YYYY-MM-DD') AS PJ_START_DATE
			, TO_CHAR(PH_MAINWORK_END_DATE, 'YYYY-MM-DD') AS PJ_END_DATE
			, PH_MAINWORK_CODE
			, U_P_APPLY_CODE
			FROM PH_MAINWORK
			WHERE U_P_APPLY_CODE IN (
				SELECT P3.U_P_APPLY_CODE
				FROM P P1, P_POSITION P2, U_P_APPLY P3, P_REJECT P4
				WHERE P1.P_CODE = (
					SELECT T3.P_CODE
					FROM U_P_APPLY T1, P_POSITION T2, P T3
					WHERE T1.U_P_APPLY_CODE = #{u_p_apply_code}
					  AND T1.P_POSITION_CODE = T2.P_POSITION_CODE
					  AND T2.P_CODE = T3.P_CODE
				)  
				 AND P1.P_CODE = P2.P_CODE
				 AND P2.P_POSITION_CODE = P3.P_POSITION_CODE
				 AND NOT P3.U_P_APPLY_CODE = P4.U_P_APPLY_CODE
			)
		) C1, PH_MAINWORK_MEMBER C2, U_P_APPLY C3, U C4
		WHERE C1.PH_MAINWORK_CODE = C2.PH_MAINWORK_CODE
		  AND C2.U_P_APPLY_CODE = C3.U_P_APPLY_CODE
		  AND C3.USER_CODE = C4.USER_CODE
	</select>
	
	
	<select id="mainWorkInsertForm_memberlist" resultType="com.test.dto.InnerProjectMainWorkDTO">
		SELECT 
		P3.U_P_APPLY_CODE AS UPA_CODE,
		P4.U_NAME AS INSERT_MEMBER
		FROM P P1, P_POSITION P2, U_P_APPLY P3, U P4
		WHERE P1.P_CODE = (
			SELECT T3.P_CODE
			FROM U_P_APPLY T1, P_POSITION T2, P T3
			WHERE T1.U_P_APPLY_CODE = #{u_p_apply_code}
			  AND T1.P_POSITION_CODE = T2.P_POSITION_CODE
			  AND T2.P_CODE = T3.P_CODE
		)  
		AND P1.P_CODE = P2.P_CODE
		AND P2.P_POSITION_CODE = P3.P_POSITION_CODE
		AND P3.U_P_APPLY_CODE NOT IN (SELECT U_P_APPLY_CODE FROM P_REJECT)
		AND P3.USER_CODE = P4.USER_CODE
		ORDER BY UPA_CODE ASC
	</select>
	
	
	
	<insert id="mainWorkInsert">
		INSERT INTO PH_MAINWORK(PH_MAINWORK_CODE, U_P_APPLY_CODE, PH_MAINWORK_START_DATE, PH_MAINWORK_END_DATE, PH_MAINWORK_DATE, PH_MAINWORK_TITLE)
		VALUES('PHMW'|| LPAD(PH_MAINWORK_CODE_SEQ.NEXTVAL, 6,'0')
		, #{u_p_apply_code}
		, TO_DATE(#{ph_mainwork_start_date},'YYYY-MM-DD HH24:MI:SS')
		, TO_DATE(#{ph_mainwork_end_date},'YYYY-MM-DD HH24:MI:SS')
		, TO_DATE(SYSDATE,'YYYY-MM-DD HH24:MI:SS')
		, #{ph_mainwork_title}
		)
	</insert>
	
	
	
	<insert id="mainWorkMemberInsert">
		INSERT INTO PH_MAINWORK_MEMBER(PH_MAINWORK_MEMBER_CODE, U_P_APPLY_CODE, PH_MAINWORK_CODE)
		SELECT ('PHMWM'|| LPAD(PH_MAINWORK_MEMBER_CODE_SEQ.NEXTVAL, 5,'0'))
		, A.* 
		FROM (
		<foreach collection="list" item="item"  index="index" separator=" UNION ALL ">
		SELECT
		#{item} AS U_P_APPLY_CODE
		, (SELECT MAX(PH_MAINWORK_CODE) FROM PH_MAINWORK) AS PH_MAINWORK_CODE
		FROM DUAL
		</foreach>
		) A
	</insert>
	
	
	
	
	
	
	
	
</mapper>